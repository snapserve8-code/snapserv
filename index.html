<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snapserv</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow-x: hidden;
        }

        /* ==================== RESPONSIVENESS ==================== */

        /* Tablets */
        @media (max-width: 900px) {
            .media-container {
                gap: 15px;
            }
            .media-container img,
            .media-container video {
                width: 30%;
                max-width: 280px;
            }
        }

        /* Phones */
        @media (max-width: 600px) {
            .media-container {
                flex-wrap: wrap; /* still horizontal but can wrap */
            }

            .media-container img,
            .media-container video {
                width: 90%;
                max-width: 350px;
            }
        }

        /* Responsive adjustments */
        /* ==================== INTAKE FORM PAGE ==================== */
        #intake-page {
            min-height: 100vh;
            background-image: url('assets/galla48.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
        }

        #intake-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .intake-nav {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .nav-btn {
            padding: 12px 30px;
            background-color: #D4AF37;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background-color: #FFD700;
            transform: translateY(-2px);
        }

        .snapserv-logo {
            height: 50px;
            width: auto;
        }

        .intake-container {
            position: relative;
            z-index: 2;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            align-items: center;
        }

        .info-section {
            color: #fff;
        }

        .gold-heading {
            font-size: 3rem;
            color: #D4AF37;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .info-section p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 20px;
            opacity: 0.95;
        }

        .form-section {
            display: flex;
            justify-content: center;
        }

        .form-card {
            background-color: #000;
            padding: 40px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .form-card h3 {
            color: #fff;
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .form-subtitle {
            color: #ccc;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #fff;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #D4AF37;
        }

        .form-group input::placeholder {
            color: #666;
        }

        .consent-group {
            margin: 25px 0;
        }

        .consent-label {
            display: flex;
            align-items: center;
            color: #fff;
            cursor: pointer;
        }

        .consent-label input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }

        .staff-section {
            background-color: rgba(212, 175, 55, 0.1);
            border: 2px solid #D4AF37;
            border-radius: 10px;
            padding: 20px;
            margin: 25px 0;
        }

        .staff-header {
            color: #D4AF37;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .gold-btn {
            width: 100%;
            padding: 15px;
            background-color: #D4AF37;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .gold-btn:hover {
            background-color: #FFD700;
            transform: translateY(-2px);
        }

        .success-message {
            background-color: #27ae60;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }

        /* ==================== STAFF DASHBOARD ==================== */
        #staff-dashboard {
            min-height: 100vh;
            background-color: #0a0a0a;
            padding: 20px;
        }

        .dashboard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background-color: #000;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .back-btn {
            background-color: #333;
        }

        .back-btn:hover {
            background-color: #444;
        }

        .login-container {
            max-width: 500px;
            margin: 100px auto;
        }

        .login-card {
            background-color: #000;
            padding: 40px;
            border-radius: 15px;
            border: 1px solid #D4AF37;
        }

        .login-card h2 {
            color: #D4AF37;
            text-align: center;
            margin-bottom: 10px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header-card {
            background-color: #000;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .dashboard-header-card h2 {
            color: #D4AF37;
            margin: 0;
            font-size: 2rem;
        }

        .dashboard-header-card p {
            color: #ccc;
            margin: 5px 0 0 0;
        }

        .logout-btn {
            background-color: #c0392b;
        }

        .logout-btn:hover {
            background-color: #e74c3c;
        }

        .dashboard-tabs-card {
            background-color: #000;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 25px;
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background-color: #2a2a2a;
            border-color: #D4AF37;
        }

        .tab-btn.active {
            background-color: #D4AF37;
            color: #000;
            border-color: #D4AF37;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #000;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #333;
        }

        .stat-card h4 {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .stat-value {
            color: #D4AF37;
            font-size: 2.5rem;
            font-weight: bold;
        }

        .chart-card {
            background-color: #000;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .gold-heading {
            color: #D4AF37;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card canvas {
            max-height: 350px;
        }

        .data-table {
            background-color: #1a1a1a;
            border-radius: 10px;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            color: #fff;
        }

        .data-table th {
            background-color: #D4AF37;
            color: #000;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
        }

        .data-table tr:hover {
            background-color: #2a2a2a;
        }

        .export-section {
            background-color: #000;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #333;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            width: auto;
            min-width: 200px;
        }

        /* Tablet responsive for dashboard */
        @media (max-width: 1024px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-nav {
                padding: 15px 20px;
            }

            .dashboard-header-card {
                padding: 20px;
            }

            .dashboard-header-card h2 {
                font-size: 1.5rem;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .tab-btn {
                width: 100%;
            }

            .export-btn {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .intake-container {
                grid-template-columns: 1fr;
                gap: 30px;
                padding: 20px;
            }

            .gold-heading {
                font-size: 2.2rem;
            }

            .info-section {
                text-align: center;
            }

            .form-card {
                padding: 30px 20px;
            }
        }

        @media (max-width: 768px) {
            .intake-nav {
                padding: 15px 20px;
            }

            .snapserv-logo {
                height: 40px;
            }

            .gold-heading {
                font-size: 1.8rem;
            }

            .info-section p {
                font-size: 1rem;
            }
        }
            .cover-heading .welcome {
                font-size: 1.5rem;
            }

            .cover-heading .tempo-luxury {
                font-size: 2.5rem;
            }

            .media-container img,
            .media-container video {
                width: 100%;
                max-width: 350px;
                height: 300px;
            }
        
            /* ==================== SEATING PAGE ==================== */
            #seating-page {
                min-height: 100vh;
                background-image: url('assets/galla48.jpg');
                background-size: cover;
                background-position: center;
                position: relative;
                padding: 20px;
            }

            #seating-page::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1;
            }

            /* Ensure all content inside seating-page is above the overlay */
            #seating-page > * {
                position: relative;
                z-index: 2;
            }



    </style>
</head>
<body>


    <!-- ==================== INTAKE FORM PAGE ==================== -->
    <section id="intake-page">
        <!-- Navigation Bar -->
        <nav class="intake-nav">
            <button class="nav-btn staff-btn" onclick="goToStaffDashboard()">Staff Dashboard</button>
            <button class="nav-btn" onclick="goToSeating()">Seating</button>
            <img src="assets/snapserv.png" alt="Snapserv Logo" class="snapserv-logo">
        </nav>

        <!-- Main Content -->
        <div class="intake-container">
            <!-- Left Side - Info Text -->
            <div class="info-section">
                <h2 class="gold-heading">Welcome to Tempo Luxury</h2>
                <p>Tempo is more than a destination â€” it's a sanctuary. Our interiors blend elegance with comfort, inviting guests to relax, connect, and indulge. Every detail, from lighting to layout, is curated to feel both refined and familiar.</p>
                <p>Led by Chef Bonga Williams, Tempo blends precision and passion to deliver a sensory journey. From intimate evenings to vibrant celebrations, every detail is designed to reflect luxury, warmth, and South African flair. Our curated playlists shift from relaxed daytime ambiance to energetic nightlife, creating a dynamic rhythm that complements every dish.</p>
                <p>.</p>

                <p>Powered by Snapserv</p>
            </div>

            <!-- Right Side - Forms -->
            <div class="form-section">
                <!-- Phone Lookup Form -->
                <div class="form-card" id="phoneLookupCard">
                    <h3>Welcome</h3>
                    <p class="form-subtitle">Enter your details to check in</p>
                    
                    <form id="phoneLookupForm">
                        <div class="form-group">
                            <label for="lookupName">Full Name</label>
                            <input type="text" id="lookupName" name="lookupName" required placeholder="Your name">
                        </div>

                        <div class="form-group">
                            <label for="lookupPhone">Phone Number</label>
                            <input type="tel" id="lookupPhone" name="lookupPhone" required placeholder="+27 XX XXX XXXX">
                        </div>

                        <button type="submit" class="gold-btn">Continue</button>
                    </form>
                </div>

                <!-- Full Guest Form (Hidden initially) -->
                <div class="form-card" id="fullGuestCard" style="display: none;">
                    <div id="welcomeBackMessage" style="display: none;"></div>
                    
                    <h3>Guest Information</h3>
                    <p class="form-subtitle">Please complete your details</p>

                    <form id="guestForm">
                        <input type="hidden" id="guestId" name="guestId">
                        <input type="hidden" id="visitCount" name="visitCount" value="1">

                        <div class="form-group">
                            <label for="name">Full Name *</label>
                            <input type="text" id="name" name="name" required placeholder="Your name">
                        </div>

                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" name="email" required placeholder="your.email@example.com">
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" required placeholder="+27 XX XXX XXXX" readonly>
                        </div>

                        <div class="form-group">
                            <label for="partySize">Party Size *</label>
                            <input type="number" id="partySize" name="partySize" min="1" max="50" required placeholder="Number of guests">
                        </div>

                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" name="gender">
                                <option value="">Prefer not to say</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="consent-group">
                            <label class="consent-label">
                                <input type="checkbox" id="marketingConsent" name="marketingConsent">
                                <span>I would like to receive marketing updates</span>
                            </label>
                        </div>

                        <button type="submit" class="gold-btn">Submit</button>

                        <div class="success-message" id="successMessage" style="display: none;">
                            âœ“ Thank you! Check-in successful.
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>


        <!-- ==================== SEATING ASSIGNMENT PAGE ==================== -->
    <section id="seating-page" style="display: none;">
        <nav class="dashboard-nav">
            <img src="assets/snapserv.png" alt="Snapserv Logo" class="snapserv-logo">
            <button class="nav-btn back-btn" onclick="goBackToIntake()">Back to Check-In</button>
        </nav>

        <div class="dashboard-container" style="padding-top: 20px;">
            <div class="dashboard-header-card">
                <div>
                    <h2>ðŸª‘ Seating Assignment</h2>
                    <p>Assign waiters and tables to checked-in guests</p>
                </div>
                <button class="gold-btn" onclick="refreshSeatingList()" style="width: auto; padding: 12px 30px;">
                    ðŸ”„ Refresh List
                </button>
            </div>

            <!-- Unassigned Guests Table -->
            <div class="chart-card full-width">
                <h3 class="gold-heading">Guests Awaiting Seating</h3>
                <div class="data-table" id="unseatedGuestsTable">
                    <p style="color: #ccc; text-align: center; padding: 40px;">Loading guests...</p>
                </div>
            </div>

            <!-- Recently Seated Guests -->
            <div class="chart-card full-width" style="margin-top: 20px;">
                <h3 class="gold-heading">Recently Seated (Last 20)</h3>
                <div class="data-table" id="recentlySeatedTable">
                    <p style="color: #ccc; text-align: center; padding: 40px;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Seating Assignment Modal -->
        <div id="seatingModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
            <div class="form-card" style="max-width: 600px; margin: 0;">
                <h3 style="color: #D4AF37; margin-bottom: 20px;">Assign Seating</h3>
                
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                    <p style="color: #fff; margin: 5px 0;"><strong>Guest:</strong> <span id="modalGuestName"></span></p>
                    <p style="color: #fff; margin: 5px 0;"><strong>Party Size:</strong> <span id="modalPartySize"></span></p>
                    <p style="color: #fff; margin: 5px 0;"><strong>Phone:</strong> <span id="modalPhone"></span></p>
                </div>

                <form id="seatingAssignmentForm">
                    <input type="hidden" id="modalVisitId">
                    <input type="hidden" id="modalGuestId">

                    <div class="form-group">
                        <label for="modalWaiter">Assigned Waiter *</label>
                        <select id="modalWaiter" name="waiter" required>
                            <option value="">Select Waiter</option>
                            <option value="Washington">Washington</option>
                            <option value="Minenhle">Minenhle</option>
                            <option value="Esnathi">Esnathi</option>
                            <option value="Latoya">Latoya</option>
                            <option value="Primrose">Primrose</option>
                            <option value="Tracy">Tracy</option>
                            <option value="Ronald">Ronald</option>
                            <option value="William Doc">William Doc</option>
                            <option value="Melusi">Melusi</option>
                            <option value="Dylan">Dylan</option>
                            <option value="Sipho">Sipho</option>
                            <option value="Witness">Witness</option>
                            <option value="Unathi">Unathi</option>
                            <option value="Sarah">Sarah</option>
                            <option value="Faith">Faith</option>
                            <option value="Taina">Taina</option>
                            <option value="Wellyngton">Wellyngton</option>
                            <option value="Sthe">Sthe</option>
                            <option value="Cherity">Cherity</option>
                            <option value="Phoka">Phoka</option>
                            <option value="Bale">Bale</option>
                            <option value="Kgotatso">Kgotatso</option>
                            <option value="Thabiso">Thabiso</option>
                            <option value="Ben">Ben</option>
                            <option value="Phindile">Phindile</option>
                            <option value="TK">TK</option>
                            <option value="Getrude">Getrude</option>
                            <option value="Nomsizi">Nomsizi</option>
                            <option value="Tthobani">Tthobani</option>
                            <option value="Neale">Neale</option>
                            <option value="Zintle">Zintle</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modalTable">Table *</label>
                        <select id="modalTable" name="tableNumber" required>
                            <option value="">Select Table</option>
                            <optgroup label="Private Rooms (200â€“214)">
                                <option>Private Room â€“ 200</option>
                                <option>Private Room â€“ 201</option>
                                <option>Private Room â€“ 202</option>
                                <option>Private Room â€“ 203</option>
                                <option>Private Room â€“ 204</option>
                                <option>Private Room â€“ 205</option>
                                <option>Private Room â€“ 206</option>
                                <option>Private Room â€“ 207</option>
                                <option>Private Room â€“ 208</option>
                                <option>Private Room â€“ 209</option>
                                <option>Private Room â€“ 210</option>
                                <option>Private Room â€“ 211</option>
                                <option>Private Room â€“ 212</option>
                                <option>Private Room â€“ 213</option>
                                <option>Private Room â€“ 214</option>
                            </optgroup>
                            <optgroup label="Blue Couches (100â€“124)">
                                <option>Blue Couch â€“ 100</option>
                                <option>Blue Couch â€“ 101</option>
                                <option>Blue Couch â€“ 102</option>
                                <option>Blue Couch â€“ 103</option>
                                <option>Blue Couch â€“ 104</option>
                                <option>Blue Couch â€“ 105</option>
                                <option>Blue Couch â€“ 106</option>
                                <option>Blue Couch â€“ 107</option>
                                <option>Blue Couch â€“ 108</option>
                                <option>Blue Couch â€“ 109</option>
                                <option>Blue Couch â€“ 110</option>
                                <option>Blue Couch â€“ 111</option>
                                <option>Blue Couch â€“ 112</option>
                                <option>Blue Couch â€“ 113</option>
                                <option>Blue Couch â€“ 114</option>
                                <option>Blue Couch â€“ 115</option>
                                <option>Blue Couch â€“ 116</option>
                                <option>Blue Couch â€“ 117</option>
                                <option>Blue Couch â€“ 118</option>
                                <option>Blue Couch â€“ 119</option>
                                <option>Blue Couch â€“ 120</option>
                                <option>Blue Couch â€“ 121</option>
                                <option>Blue Couch â€“ 122</option>
                                <option>Blue Couch â€“ 123</option>
                                <option>Blue Couch â€“ 124</option>
                            </optgroup>
                            <optgroup label="Patio (300â€“310)">
                                <option>Patio â€“ 300</option>
                                <option>Patio â€“ 301</option>
                                <option>Patio â€“ 302</option>
                                <option>Patio â€“ 303</option>
                                <option>Patio â€“ 304</option>
                                <option>Patio â€“ 305</option>
                                <option>Patio â€“ 306</option>
                                <option>Patio â€“ 306b</option>
                                <option>Patio â€“ 307</option>
                                <option>Patio â€“ 307b</option>
                                <option>Patio â€“ 308</option>
                                <option>Patio â€“ 308b</option>
                                <option>Patio â€“ 309</option>
                                <option>Patio â€“ 309b</option>
                                <option>Patio â€“ 310</option>
                                <option>Patio â€“ 310b</option>
                            </optgroup>
                            <optgroup label="Gold Cabanas (400â€“413)">
                                <option>Gold Cabana â€“ 400</option>
                                <option>Gold Cabana â€“ 401</option>
                                <option>Gold Cabana â€“ 402</option>
                                <option>Gold Cabana â€“ 403</option>
                                <option>Gold Cabana â€“ 404</option>
                                <option>Gold Cabana â€“ 405</option>
                                <option>Gold Cabana â€“ 406</option>
                                <option>Gold Cabana â€“ 407</option>
                                <option>Gold Cabana â€“ 408</option>
                                <option>Gold Cabana â€“ 409</option>
                                <option>Gold Cabana â€“ 410</option>
                                <option>Gold Cabana â€“ 411</option>
                                <option>Gold Cabana â€“ 412</option>
                                <option>Gold Cabana â€“ 413</option>
                            </optgroup>
                            <optgroup label="Black Couches">
                                <option>Black Couch â€“ 100</option>
                                <option>Black Couch â€“ 101</option>
                                <option>Black Couch â€“ 102</option>
                                <option>Black Couch â€“ 103</option>
                                <option>Black Couch â€“ 100a</option>
                                <option>Black Couch â€“ 101b</option>
                            </optgroup>

                            <!-- Dining Tables 1-50 -->
                            <optgroup label="Dining (1â€“50)">
                                <option>Dining â€“ 1</option>
                                <option>Dining â€“ 2</option>
                                <option>Dining â€“ 3</option>
                                <option>Dining â€“ 4</option>
                                <option>Dining â€“ 5</option>
                                <option>Dining â€“ 6</option>
                                <option>Dining â€“ 7</option>
                                <option>Dining â€“ 8</option>
                                <option>Dining â€“ 9</option>
                                <option>Dining â€“ 10</option>
                                <option>Dining â€“ 11</option>
                                <option>Dining â€“ 12</option>
                                <option>Dining â€“ 13</option>
                                <option>Dining â€“ 14</option>
                                <option>Dining â€“ 15</option>
                                <option>Dining â€“ 16</option>
                                <option>Dining â€“ 17</option>
                                <option>Dining â€“ 18</option>
                                <option>Dining â€“ 19</option>
                                <option>Dining â€“ 20</option>
                                <option>Dining â€“ 21</option>
                                <option>Dining â€“ 22</option>
                                <option>Dining â€“ 23</option>
                                <option>Dining â€“ 24</option>
                                <option>Dining â€“ 25</option>
                                <option>Dining â€“ 26</option>
                                <option>Dining â€“ 27</option>
                                <option>Dining â€“ 28</option>
                                <option>Dining â€“ 29</option>
                                <option>Dining â€“ 30</option>
                                <option>Dining â€“ 31</option>
                                <option>Dining â€“ 32</option>
                                <option>Dining â€“ 33</option>
                                <option>Dining â€“ 34</option>
                                <option>Dining â€“ 35</option>
                                <option>Dining â€“ 36</option>
                                <option>Dining â€“ 37</option>
                                <option>Dining â€“ 38</option>
                                <option>Dining â€“ 39</option>
                                <option>Dining â€“ 40</option>
                                <option>Dining â€“ 41</option>
                                <option>Dining â€“ 42</option>
                                <option>Dining â€“ 43</option>
                                <option>Dining â€“ 44</option>
                                <option>Dining â€“ 45</option>
                                <option>Dining â€“ 46</option>
                                <option>Dining â€“ 47</option>
                                <option>Dining â€“ 48</option>
                                <option>Dining â€“ 49</option>
                                <option>Dining â€“ 50</option>
                            </optgroup>
                            
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button type="button" class="nav-btn" onclick="closeSeatingModal()" style="flex: 1; background: #555;">Cancel</button>
                        <button type="submit" class="gold-btn" style="flex: 1;">Assign & Save</button>
                    </div>
                </form>
            </div>
        </div>
    </section>


    <!-- ==================== STAFF DASHBOARD ==================== -->
    <section id="staff-dashboard" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="dashboard-nav">
            <img src="assets/snapserv.png" alt="Snapserv Logo" class="snapserv-logo">
            <button class="nav-btn back-btn" onclick="goBackToIntake()">Back to Check-In</button>
        </nav>

        <!-- Login Screen -->
        <div id="login-screen" class="login-container">
            <div class="login-card">
                <h2>ðŸ”’ Staff Login</h2>
                <p class="form-subtitle">Please authenticate to access the dashboard</p>

                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required placeholder="staff@tempoluxury.com">
                    </div>

                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter password">
                    </div>

                    <button type="submit" class="gold-btn">Login</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" style="display: none;">
            <div class="dashboard-container">
                <!-- Header -->
                <div class="dashboard-header-card">
                    <div>
                        <h2>ðŸ“Š Analytics Dashboard</h2>
                        <p>Welcome, <span id="userEmail">staff@tempoluxury.com</span></p>
                    </div>
                    <button class="nav-btn logout-btn" id="logoutBtn">Logout</button>
                </div>

                <!-- Dashboard Tabs -->
                <div class="dashboard-tabs-card">
                    <button class="tab-btn active" data-tab="overview">Overview</button>
                    <button class="tab-btn" data-tab="server">Server Performance</button>
                    <button class="tab-btn" data-tab="table">Table Utilization</button>
                    <button class="tab-btn" data-tab="guests">Guest Analytics</button>
                </div>

                <!-- Overview Tab -->
                <div class="tab-content active" id="overview-tab">
                    <!-- Key Statistics -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <h4>Total Guests</h4>
                            <div class="stat-value" id="totalGuests">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Repeat Guests</h4>
                            <div class="stat-value" id="repeatGuestRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <h4>Marketing Consent</h4>
                            <div class="stat-value" id="consentRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <h4>Today's Visits</h4>
                            <div class="stat-value" id="todayVisits">0</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="chart-card">
                        <h3 class="gold-heading">Filters</h3>
                        <div class="filters-grid">
                            <div class="form-group">
                                <label for="filterStartDate">Start Date</label>
                                <input type="date" id="filterStartDate">
                            </div>
                            <div class="form-group">
                                <label for="filterEndDate">End Date</label>
                                <input type="date" id="filterEndDate">
                            </div>
                            <div class="form-group">
                                <label for="filterGender">Gender</label>
                                <select id="filterGender">
                                    <option value="">All</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterConsent">Marketing Consent</label>
                                <select id="filterConsent">
                                    <option value="">All</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                        <button class="gold-btn" id="applyFilters">Apply Filters</button>
                    </div>

                    <!-- Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3 class="gold-heading">Peak Hours Analysis</h3>
                            <canvas id="peakHoursChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3 class="gold-heading">Daily Visits Trend</h3>
                            <canvas id="dailyVisitsChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3 class="gold-heading">Party Size Distribution</h3>
                            <canvas id="partySizeChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3 class="gold-heading">Gender Distribution</h3>
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Server Performance Tab -->
                <div class="tab-content" id="server-tab">
                    <div class="stats-row">
                        <div class="stat-card">
                            <h4>Total Servers</h4>
                            <div class="stat-value" id="totalServers">30</div>
                        </div>
                        <div class="stat-card">
                            <h4>Avg Party Size</h4>
                            <div class="stat-value" id="avgServerPartySize">0</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3 class="gold-heading">Visits per Server</h3>
                            <canvas id="serverVisitsChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3 class="gold-heading">Average Party Size by Server</h3>
                            <canvas id="serverPartySizeChart"></canvas>
                        </div>

                        <div class="chart-card full-width">
                            <h3 class="gold-heading">Server Performance Details</h3>
                            <div class="data-table" id="serverTable"></div>
                        </div>
                    </div>
                </div>

                <!-- Table Utilization Tab -->
                <div class="tab-content" id="table-tab">
                    <div class="stats-row">
                        <div class="stat-card">
                            <h4>Total Tables</h4>
                            <div class="stat-value" id="totalTables">10</div>
                        </div>
                        <div class="stat-card">
                            <h4>Most Used Table</h4>
                            <div class="stat-value" id="mostUsedTable">-</div>
                        </div>
                        <div class="stat-card">
                            <h4>Avg Turnover</h4>
                            <div class="stat-value" id="avgTurnover">-</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3 class="gold-heading">Table Usage Frequency</h3>
                            <canvas id="tableUsageChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3 class="gold-heading">Average Party Size by Table</h3>
                            <canvas id="tablePartySizeChart"></canvas>
                        </div>

                        <div class="chart-card full-width">
                            <h3 class="gold-heading">Table Utilization Details</h3>
                            <div class="data-table" id="tableDetailsTable"></div>
                        </div>
                    </div>
                </div>

                <!-- Guest Analytics Tab -->
                <div class="tab-content" id="guests-tab">
                    <div class="stats-row">
                        <div class="stat-card">
                            <h4>New Guests</h4>
                            <div class="stat-value" id="newGuests">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Returning Guests</h4>
                            <div class="stat-value" id="returningGuests">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Average Visits</h4>
                            <div class="stat-value" id="avgVisits">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Top Visitor</h4>
                            <div class="stat-value" id="topVisitor" style="font-size: 1.2em;">-</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3 class="gold-heading">New vs Returning Guests</h3>
                            <canvas id="guestTypeChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3 class="gold-heading">Visit Frequency Distribution</h3>
                            <canvas id="visitFrequencyChart"></canvas>
                        </div>

                        <div class="chart-card full-width">
                            <h3 class="gold-heading">Top Returning Guests</h3>
                            <div class="data-table" id="topGuestsTable"></div>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="export-section">
                    <h3 class="gold-heading">Export Data</h3>
                    <div class="export-buttons">
                        <button class="gold-btn export-btn" id="exportCSV">Export to CSV</button>
                        <button class="gold-btn export-btn" id="exportPDF">Export to PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_dmdFrPFKwpTvUB-COczFkhy_JRtIMHM",
        authDomain: "snapserv-8e7f5.firebaseapp.com",
        projectId: "snapserv-8e7f5",
        storageBucket: "snapserv-8e7f5.firebasestorage.app",
        messagingSenderId: "355467579052",
        appId: "1:355467579052:web:522331677ea5495bc75909",
        measurementId: "G-KGLVXRM8MX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let isAuthenticated = false;

    auth.onAuthStateChanged(user => {
    if (user) {
      // already signed in (anonymous or email/password)
      console.log('Signed in as', user.uid, 'isAnonymous:', user.isAnonymous);
      isAuthenticated = true;
    } else {
      // sign in anonymously for guest checkins (this satisfies request.auth != null)
      auth.signInAnonymously()
        .then(() => {
          console.log('Anonymous auth signed in');
          isAuthenticated = true;
        })
        .catch(err => {
          console.error('Anonymous auth failed', err);
          alert('Authentication failed. Please refresh the page.');
        });
    }
    });
    

    // ---------- Table parsing helper ----------
    /**
     * Input: "Patio â€“ 306b"  OR "Blue Couch â€“ 100"
     * Returns:
     *  {
     *    section: "Patio",
     *    full: "Patio â€“ 306b",
     *    variant: "306b" or null,
     *    base: "306" (base numeric string),
     *    label: "Patio â€“ 306b"
     *  }
     */
    function parseTableLabel(label) {
        if (!label) return { section: null, full: null, variant: null, base: null, label: null };

        // split "Section â€“ number/variant"
        const parts = label.split('â€“').map(p => p.trim());
        const section = parts[0] || null;
        const variantPart = parts[1] || '';

        // extract digits prefix as base, keep any trailing letters as variant
        // e.g., 306b => base 306, variant 306b
        const match = variantPart.match(/^(\d+)([a-zA-Z]*)$/);
        let base = variantPart;
        let variant = null;
        if (match) {
            base = match[1]; // '306'
            variant = match[2] ? (match[1] + match[2]) : null; // '306b' or null
        }

        return {
            section,
            full: label,
            variant, // e.g. "306b" or null
            base,    // e.g. "306"
            label: label
        };
    }



    // ==================== NAVIGATION & PAGE SWITCHING ====================
    

    // Navigate to staff dashboard
    function goToStaffDashboard() {
        document.getElementById('intake-page').style.display = 'none';
        document.getElementById('staff-dashboard').style.display = 'block';
        document.getElementById('seating-page').style.display = 'none';
    }

    //Navigate to seating page
    function goToSeating() {
        document.getElementById('intake-page').style.display = 'none';
        document.getElementById('seating-page').style.display = 'block';
        document.getElementById('staff-dashboard').style.display = 'none';
        loadSeatingData();
    }

    // Go back to intake page
    function goBackToIntake() {
        document.getElementById('intake-page').style.display = 'block';
        document.getElementById('staff-dashboard').style.display = 'none';
        document.getElementById('seating-page').style.display = 'none';
    }

    // ==================== PHONE LOOKUP FORM ====================
    
    document.getElementById('phoneLookupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('lookupName').value;
        const phone = document.getElementById('lookupPhone').value;

        try {
            // Query Firestore for existing guest
            const guestsRef = db.collection('guests');
            const snapshot = await guestsRef.where('phone', '==', phone).get();

            if (!snapshot.empty) {
                // Returning guest found
                const guestDoc = snapshot.docs[0];
                const guestData = guestDoc.data();
                
                // Pre-fill the full form
                document.getElementById('guestId').value = guestDoc.id;
                document.getElementById('name').value = guestData.name;
                document.getElementById('email').value = guestData.email || '';
                document.getElementById('phone').value = guestData.phone;
                document.getElementById('gender').value = guestData.gender || '';
                document.getElementById('marketingConsent').checked = guestData.marketingConsent || false;
                document.getElementById('visitCount').value = (guestData.visitCount || 0) + 1;

                // Show welcome back message
                document.getElementById('welcomeBackMessage').innerHTML = 
                    `<div class="success-message" style="display: block;">Welcome back, ${guestData.name}! Visit #${(guestData.visitCount || 0) + 1}</div>`;
                document.getElementById('welcomeBackMessage').style.display = 'block';
            } else {
                // New guest
                document.getElementById('name').value = name;
                document.getElementById('phone').value = phone;
                document.getElementById('visitCount').value = 1;
            }

            // Hide phone lookup, show full form
            document.getElementById('phoneLookupCard').style.display = 'none';
            document.getElementById('fullGuestCard').style.display = 'block';

        } catch (error) {
            console.error('Error looking up guest:', error);
            alert('Error checking guest information. Please try again.');
        }
    });

    // ==================== GUEST FORM SUBMISSION ====================
    
    document.getElementById('guestForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const guestId = document.getElementById('guestId').value;

    const formData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        partySize: parseInt(document.getElementById('partySize').value),
        gender: document.getElementById('gender').value,
        marketingConsent: document.getElementById('marketingConsent').checked,
        waiter: null,
        tableSection: null,
        tableNumber: null,
        tableVariant: null,
        tableLabel: null,
        visitCount: parseInt(document.getElementById('visitCount').value),
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        date: new Date().toISOString().split('T')[0],
        time: new Date().toLocaleTimeString('en-US', { hour12: false })
    };

    try {
        if (guestId) {
            // Update existing guest
            await db.collection('guests').doc(guestId).update({
                ...formData,
                lastVisit: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            // Create new guest
            const docRef = await db.collection('guests').add({
                ...formData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastVisit: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('guestId').value = docRef.id;
        }

        // Add visit record (include same table structured fields)
        await db.collection('visits').add({
            guestId: guestId || document.getElementById('guestId').value,
            guestName: formData.name,
            phone: formData.phone,
            partySize: formData.partySize,
            waiter: formData.waiter,
            tableSection: formData.tableSection,
            tableNumber: formData.tableNumber,   // base
            tableVariant: formData.tableVariant, // variant if any
            tableLabel: formData.tableLabel,     // full label
            date: formData.date,
            time: formData.time,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Show success message
        document.getElementById('successMessage').style.display = 'block';

        // Reset after 3 seconds
        setTimeout(() => {
            document.getElementById('guestForm').reset();
            document.getElementById('phoneLookupForm').reset();
            document.getElementById('phoneLookupCard').style.display = 'block';
            document.getElementById('fullGuestCard').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('welcomeBackMessage').style.display = 'none';
            document.getElementById('guestId').value = '';
        }, 3000);

    } catch (error) {
        console.error('Error saving guest:', error);
        alert('Error saving information. Please try again.');
    }
});


    // ==================== STAFF AUTHENTICATION ====================
    
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            await auth.signInWithEmailAndPassword(email, password);
            
            // Show dashboard
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('userEmail').textContent = email;

            // Load dashboard data
            loadDashboardData();

        } catch (error) {
            console.error('Login error:', error);
            alert('Invalid credentials. Please try again.');
        }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            await auth.signOut();
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('loginForm').reset();
        } catch (error) {
            console.error('Logout error:', error);
        }
    });

    // ==================== DASHBOARD TABS ====================
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;

            // Update active button
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${targetTab}-tab`).classList.add('active');

            // Load specific tab data
            loadTabData(targetTab);
        });
    });


    // ==================== LOAD DASHBOARD DATA ====================
    
    async function loadDashboardData() {
        try {
            // Load all visits
            const visitsSnapshot = await db.collection('visits').get();
            const visits = visitsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Load all guests
            const guestsSnapshot = await db.collection('guests').get();
            const guests = guestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Calculate statistics
            updateOverviewStats(visits, guests);
            createOverviewCharts(visits, guests);

        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    function updateOverviewStats(visits, guests) {
        // Total guests
        document.getElementById('totalGuests').textContent = guests.length;

        // Repeat guest rate
        const repeatGuests = guests.filter(g => g.visitCount > 1).length;
        const repeatRate = guests.length > 0 ? ((repeatGuests / guests.length) * 100).toFixed(1) : 0;
        document.getElementById('repeatGuestRate').textContent = repeatRate + '%';

        // Marketing consent rate
        const consentCount = guests.filter(g => g.marketingConsent).length;
        const consentRate = guests.length > 0 ? ((consentCount / guests.length) * 100).toFixed(1) : 0;
        document.getElementById('consentRate').textContent = consentRate + '%';

        // Today's visits
        const today = new Date().toISOString().split('T')[0];
        const todayVisits = visits.filter(v => v.date === today).length;
        document.getElementById('todayVisits').textContent = todayVisits;
    }

    // ==================== CHARTS (using Chart.js) ====================
    
    function createOverviewCharts(visits, guests) {
        // Peak Hours Chart
        const hourCounts = {};
        visits.forEach(v => {
            if (v.time) {
                const hour = parseInt(v.time.split(':')[0]);
                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            }
        });

        const hours = Object.keys(hourCounts).sort((a, b) => a - b);
        const counts = hours.map(h => hourCounts[h]);

        new Chart(document.getElementById('peakHoursChart'), {
            type: 'bar',
            data: {
                labels: hours.map(h => h + ':00'),
                datasets: [{
                    label: 'Visits',
                    data: counts,
                    backgroundColor: '#D4AF37'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });

        // Daily Visits Trend
        const dateCounts = {};
        visits.forEach(v => {
            if (v.date) {
                dateCounts[v.date] = (dateCounts[v.date] || 0) + 1;
            }
        });

        const dates = Object.keys(dateCounts).sort();
        const dailyCounts = dates.map(d => dateCounts[d]);

        new Chart(document.getElementById('dailyVisitsChart'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Daily Visits',
                    data: dailyCounts,
                    borderColor: '#D4AF37',
                    backgroundColor: 'rgba(212, 175, 55, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });

        // Party Size Distribution
        const partySizes = {};
        visits.forEach(v => {
            const size = v.partySize || 0;
            partySizes[size] = (partySizes[size] || 0) + 1;
        });

        new Chart(document.getElementById('partySizeChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(partySizes),
                datasets: [{
                    data: Object.values(partySizes),
                    backgroundColor: [
                        '#D4AF37',
                        '#FFD700',
                        '#C0A030',
                        '#B8960E',
                        '#8B7500'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });

        // Gender Distribution
        const genderCounts = { male: 0, female: 0, other: 0 };
        guests.forEach(g => {
            if (g.gender) genderCounts[g.gender]++;
        });

        new Chart(document.getElementById('genderChart'), {
            type: 'doughnut',
            data: {
                labels: ['Male', 'Female', 'Other'],
                datasets: [{
                    data: [genderCounts.male, genderCounts.female, genderCounts.other],
                    backgroundColor: ['#3498db', '#e74c3c', '#95a5a6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });
    }

    async function loadTabData(tab) {
        const visitsSnapshot = await db.collection('visits').get();
        const visits = visitsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const guestsSnapshot = await db.collection('guests').get();
        const guests = guestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (tab === 'server') {
            loadServerData(visits);
        } else if (tab === 'table') {
            loadTableData(visits);
        } else if (tab === 'guests') {
            loadGuestData(visits, guests);
        }
    }

    function loadServerData(visits) {
        const serverStats = {};
        visits.forEach(v => {
            if (v.waiter) {
                if (!serverStats[v.waiter]) {
                    serverStats[v.waiter] = { visits: 0, totalPartySize: 0 };
                }
                serverStats[v.waiter].visits++;
                serverStats[v.waiter].totalPartySize += v.partySize || 0;
            }
        });

        // Server visits chart
        const serverNames = Object.keys(serverStats);
        const serverVisits = serverNames.map(s => serverStats[s].visits);

        new Chart(document.getElementById('serverVisitsChart'), {
            type: 'bar',
            data: {
                labels: serverNames,
                datasets: [{
                    label: 'Visits',
                    data: serverVisits,
                    backgroundColor: '#D4AF37'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y'
            }
        });

        // Average party size by server
        const avgPartySizes = serverNames.map(s => 
            (serverStats[s].totalPartySize / serverStats[s].visits).toFixed(1)
        );

        new Chart(document.getElementById('serverPartySizeChart'), {
            type: 'bar',
            data: {
                labels: serverNames,
                datasets: [{
                    label: 'Avg Party Size',
                    data: avgPartySizes,
                    backgroundColor: '#3498db'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y'
            }
        });

        // Server table
        let tableHTML = '<table><thead><tr><th>Server</th><th>Visits</th><th>Avg Party Size</th></tr></thead><tbody>';
        serverNames.forEach(server => {
            const avgSize = (serverStats[server].totalPartySize / serverStats[server].visits).toFixed(1);
            tableHTML += `<tr><td>${server}</td><td>${serverStats[server].visits}</td><td>${avgSize}</td></tr>`;
        });
        tableHTML += '</tbody></table>';
        document.getElementById('serverTable').innerHTML = tableHTML;
    }

    function loadTableData(visits) {
    // Build grouping: section -> baseTable -> stats
    const sectionStats = {};
    visits.forEach(v => {
        // Use stored fields if present, else fallback to old v.tableNumber or v.tableLabel
        const section = v.tableSection || (v.tableLabel ? v.tableLabel.split('â€“')[0].trim() : 'Unknown');
        const base = v.tableNumber || (v.tableLabel ? (v.tableLabel.split('â€“')[1] || '').trim().match(/^(\d+)/)?.[1] : null) || 'unknown';
        // normalize as string
        const baseKey = String(base);

        if (!sectionStats[section]) sectionStats[section] = {};
        if (!sectionStats[section][baseKey]) sectionStats[section][baseKey] = { visits: 0, totalPartySize: 0, variants: {} };

        sectionStats[section][baseKey].visits++;
        sectionStats[section][baseKey].totalPartySize += v.partySize || 0;

        // record variant (if provided)
        if (v.tableVariant) {
            const variant = v.tableVariant;
            sectionStats[section][baseKey].variants[variant] = (sectionStats[section][baseKey].variants[variant] || 0) + 1;
        }
    });

    // Compute total unique base tables across all sections
    let totalBaseTables = 0;
    Object.keys(sectionStats).forEach(section => {
        totalBaseTables += Object.keys(sectionStats[section]).length;
    });
    document.getElementById('totalTables').textContent = totalBaseTables;

    // Determine most used table (by section+base)
    let mostUsed = { section: null, base: null, visits: 0 };
    Object.keys(sectionStats).forEach(section => {
        Object.keys(sectionStats[section]).forEach(base => {
            const s = sectionStats[section][base];
            if (s.visits > mostUsed.visits) {
                mostUsed = { section, base, visits: s.visits };
            }
        });
    });
    document.getElementById('mostUsedTable').textContent = mostUsed.section ? `${mostUsed.section} â€“ ${mostUsed.base}` : '-';

    // Build charts: Table Usage grouped by section (flatten to labels + counts)
    const flatLabels = [];
    const flatCounts = [];
    Object.keys(sectionStats).forEach(section => {
        Object.keys(sectionStats[section]).sort((a,b) => parseInt(a)-parseInt(b)).forEach(base => {
            flatLabels.push(`${section} â€“ ${base}`);
            flatCounts.push(sectionStats[section][base].visits);
        });
    });

    // Update Table Usage Chart (recreate chart)
    if (window._tableUsageChart) window._tableUsageChart.destroy();
    window._tableUsageChart = new Chart(document.getElementById('tableUsageChart'), {
        type: 'bar',
        data: {
            labels: flatLabels,
            datasets: [{
                label: 'Visits',
                data: flatCounts,
                backgroundColor: '#D4AF37'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true
        }
    });

    // Average party size by grouped table
    const avgSizes = flatLabels.map((lbl, i) => {
        const [sectionPart, basePart] = lbl.split('â€“').map(s => s.trim());
        const v = sectionStats[sectionPart][basePart];
        return v && v.visits ? (v.totalPartySize / v.visits).toFixed(1) : 0;
    });

    if (window._tablePartySizeChart) window._tablePartySizeChart.destroy();
    window._tablePartySizeChart = new Chart(document.getElementById('tablePartySizeChart'), {
        type: 'bar',
        data: {
            labels: flatLabels,
            datasets: [{
                label: 'Avg Party Size',
                data: avgSizes,
                backgroundColor: '#3498db'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true
        }
    });

    // Build the sectioned HTML table for tableDetailsTable
    let tableHTML = '<div style="padding:12px;"><h4 style="margin-bottom:8px;">Table Utilization by Section</h4>';
    Object.keys(sectionStats).forEach(section => {
        tableHTML += `<h5 style="margin:10px 0 6px 0;">${section}</h5>`;
        tableHTML += '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#D4AF37;color:#000"><th style="padding:8px;text-align:left">Table</th><th style="padding:8px;text-align:left">Visits</th><th style="padding:8px;text-align:left">Avg Party Size</th><th style="padding:8px;text-align:left">Variants</th></tr></thead><tbody>';

        Object.keys(sectionStats[section]).sort((a,b) => parseInt(a)-parseInt(b)).forEach(base => {
            const stat = sectionStats[section][base];
            const avg = stat.visits ? (stat.totalPartySize / stat.visits).toFixed(1) : '0';
            // variants breakdown (e.g., 306b: 3 visits)
            let variantHtml = '-';
            const variantKeys = Object.keys(stat.variants);
            if (variantKeys.length) {
                variantHtml = variantKeys.map(k => `${k} (${stat.variants[k]})`).join(', ');
            }
            tableHTML += `<tr><td style="padding:8px;">${section} â€“ ${base}</td><td style="padding:8px;">${stat.visits}</td><td style="padding:8px;">${avg}</td><td style="padding:8px;">${variantHtml}</td></tr>`;
        });

        tableHTML += '</tbody></table>';
    });
    tableHTML += '</div>';
    document.getElementById('tableDetailsTable').innerHTML = tableHTML;
}


    function loadGuestData(visits, guests) {
        const newGuests = guests.filter(g => g.visitCount === 1).length;
        const returningGuests = guests.filter(g => g.visitCount > 1).length;

        document.getElementById('newGuests').textContent = newGuests;
        document.getElementById('returningGuests').textContent = returningGuests;

        const avgVisits = guests.length > 0 
            ? (guests.reduce((sum, g) => sum + (g.visitCount || 1), 0) / guests.length).toFixed(1)
            : 0;
        document.getElementById('avgVisits').textContent = avgVisits;

        const topGuest = guests.reduce((max, g) => 
            (g.visitCount || 1) > (max.visitCount || 1) ? g : max, guests[0] || {}
        );
        document.getElementById('topVisitor').textContent = topGuest.name || '-';

        new Chart(document.getElementById('guestTypeChart'), {
            type: 'pie',
            data: {
                labels: ['New Guests', 'Returning Guests'],
                datasets: [{
                    data: [newGuests, returningGuests],
                    backgroundColor: ['#3498db', '#27ae60']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });

        const visitFreq = {};
        guests.forEach(g => {
            const count = g.visitCount || 1;
            visitFreq[count] = (visitFreq[count] || 0) + 1;
        });

        new Chart(document.getElementById('visitFrequencyChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(visitFreq).sort((a, b) => a - b).map(v => v + ' visits'),
                datasets: [{
                    label: 'Guests',
                    data: Object.values(visitFreq),
                    backgroundColor: '#D4AF37'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });

        const topGuests = guests
            .sort((a, b) => (b.visitCount || 1) - (a.visitCount || 1))
            .slice(0, 10);

        let tableHTML = '<table><thead><tr><th>Name</th><th>Phone</th><th>Visits</th></tr></thead><tbody>';
        topGuests.forEach(guest => {
            tableHTML += `<tr><td>${guest.name}</td><td>${guest.phone}</td><td>${guest.visitCount || 1}</td></tr>`;
        });
        tableHTML += '</tbody></table>';
        document.getElementById('topGuestsTable').innerHTML = tableHTML;
    }

    // ==================== FILTERS ====================
    
    document.getElementById('applyFilters').addEventListener('click', async () => {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        const gender = document.getElementById('filterGender').value;
        const consent = document.getElementById('filterConsent').value;

        let query = db.collection('visits');

        if (startDate) {
            query = query.where('date', '>=', startDate);
        }
        if (endDate) {
            query = query.where('date', '<=', endDate);
        }

        const snapshot = await query.get();
        let visits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Filter by gender and consent (client-side since Firestore has limitations)
        const guestsSnapshot = await db.collection('guests').get();
        let guests = guestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (gender) {
            guests = guests.filter(g => g.gender === gender);
        }
        if (consent) {
            const consentBool = consent === 'true';
            guests = guests.filter(g => g.marketingConsent === consentBool);
        }

        updateOverviewStats(visits, guests);
        createOverviewCharts(visits, guests);
    });

    // ==================== EXPORT FUNCTIONS ====================
    
    document.getElementById('exportCSV').addEventListener('click', async () => {
        const visitsSnapshot = await db.collection('visits').get();
        const visits = visitsSnapshot.docs.map(doc => doc.data());

        let csv = 'Name,Phone,Party Size,Waiter,Table,Date,Time\n';
        visits.forEach(v => {
            csv += `${v.guestName},${v.phone},${v.partySize},${v.waiter},${v.tableNumber},${v.date},${v.time}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tempo-luxury-data.csv';
        a.click();
    });

    document.getElementById('exportPDF').addEventListener('click', () => {
        alert('PDF export feature coming soon! Use CSV export for now.');
    });




    // ==================== SEATING ASSIGNMENT FUNCTIONS ====================

    async function loadSeatingData() {
        try {
            // FIXED: Get all visits, then filter in JavaScript to avoid index requirement
            const allVisitsSnapshot = await db.collection('visits')
                .orderBy('timestamp', 'desc')
                .get();

            const allVisits = allVisitsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            // Filter unseated guests in JavaScript (waiter is null)
            const unseatedGuests = allVisits.filter(visit => visit.waiter === null);

            // Filter seated guests in JavaScript (waiter is not null), limit to 20
            const seatedGuests = allVisits.filter(visit => visit.waiter !== null).slice(0, 20);
            displayUnseatedGuests(unseatedGuests);
        displayRecentlySeated(seatedGuests);

    } catch (error) {
        console.error('Error loading seating data:', error);
        document.getElementById('unseatedGuestsTable').innerHTML = 
            '<p style="color: #e74c3c; text-align: center; padding: 40px;">Error loading guests. Please refresh.</p>';
    }
}

function displayUnseatedGuests(guests) {
    if (guests.length === 0) {
        document.getElementById('unseatedGuestsTable').innerHTML = 
            '<p style="color: #27ae60; text-align: center; padding: 40px;">âœ“ All guests have been seated!</p>';
        return;
    }

    let html = '<table><thead><tr><th>Guest Name</th><th>Party Size</th><th>Phone</th><th>Check-in Time</th><th>Action</th></tr></thead><tbody>';
    
    guests.forEach(guest => {
        const checkInTime = guest.time || 'N/A';
        html += `
            <tr>
                <td>${guest.guestName}</td>
                <td>${guest.partySize}</td>
                <td>${guest.phone}</td>
                <td>${checkInTime}</td>
                <td>
                    <button class="gold-btn" onclick="openSeatingModal('${guest.id}', '${guest.guestId}', '${guest.guestName}', ${guest.partySize}, '${guest.phone}')" 
                            style="width: auto; padding: 8px 20px; font-size: 0.9rem;">
                        Assign Seating
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    document.getElementById('unseatedGuestsTable').innerHTML = html;
}

function displayRecentlySeated(guests) {
    if (guests.length === 0) {
        document.getElementById('recentlySeatedTable').innerHTML = 
            '<p style="color: #ccc; text-align: center; padding: 40px;">No seated guests yet.</p>';
        return;
    }

    let html = '<table><thead><tr><th>Guest Name</th><th>Party Size</th><th>Waiter</th><th>Table</th><th>Time Seated</th></tr></thead><tbody>';
    
    guests.forEach(guest => {
        const timeSeated = guest.time || 'N/A';
        const table = guest.tableLabel || guest.tableNumber || 'N/A';
        html += `
            <tr>
                <td>${guest.guestName}</td>
                <td>${guest.partySize}</td>
                <td>${guest.waiter || 'N/A'}</td>
                <td>${table}</td>
                <td>${timeSeated}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    document.getElementById('recentlySeatedTable').innerHTML = html;
}

function openSeatingModal(visitId, guestId, guestName, partySize, phone) {
    document.getElementById('modalVisitId').value = visitId;
    document.getElementById('modalGuestId').value = guestId;
    document.getElementById('modalGuestName').textContent = guestName;
    document.getElementById('modalPartySize').textContent = partySize;
    document.getElementById('modalPhone').textContent = phone;
    
    document.getElementById('seatingModal').style.display = 'flex';
}

function closeSeatingModal() {
    document.getElementById('seatingModal').style.display = 'none';
    document.getElementById('seatingAssignmentForm').reset();
}

function refreshSeatingList() {
    loadSeatingData();
}

// Handle seating assignment form submission
document.getElementById('seatingAssignmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const visitId = document.getElementById('modalVisitId').value;
    const guestId = document.getElementById('modalGuestId').value;
    const waiter = document.getElementById('modalWaiter').value;
    const selectedTableLabel = document.getElementById('modalTable').value;

    const parsedTable = parseTableLabel(selectedTableLabel);

    try {
        // Update the visit record
        await db.collection('visits').doc(visitId).update({
            waiter: waiter,
            tableSection: parsedTable.section,
            tableNumber: parsedTable.base,
            tableVariant: parsedTable.variant,
            tableLabel: parsedTable.label,
            seatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update the guest record with latest waiter/table
        if (guestId) {
            await db.collection('guests').doc(guestId).update({
                lastWaiter: waiter,
                lastTable: parsedTable.label
            });
        }

        // Close modal and refresh
        closeSeatingModal();
        loadSeatingData();

        // Show success notification (optional)
        alert('âœ“ Seating assigned successfully!');

    } catch (error) {
        console.error('Error assigning seating:', error);
        alert('Error assigning seating. Please try again.');
    }
});

</script>


</body>
</html>
